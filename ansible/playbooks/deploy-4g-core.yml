---
- name: Deploy Open5GS 4G EPC Network
  hosts: fourg_all_in_one
  become: true
  tasks:
    - name: Fix DNS resolution
      shell: |
        echo "nameserver 8.8.8.8" | tee /etc/resolv.conf > /dev/null
        echo "nameserver 1.1.1.1" >> /etc/resolv.conf

    - name: Update and upgrade apt packages
      apt:
        update_cache: yes
        upgrade: dist
        cache_valid_time: 3600

    - name: Install base dependencies
      apt:
        name:
          - software-properties-common
          - wget
          - curl
          - gnupg
          - git
          - net-tools
          - iptables
          - iputils-ping
          - tcpdump
          - vim
          - build-essential
        state: present

    # ================================
    #         MongoDB 8.0 Setup
    # ================================
    - name: Download MongoDB GPG key
      shell: |
        curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | \
        gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor
      args:
        creates: /usr/share/keyrings/mongodb-server-8.0.gpg

    - name: Add MongoDB repository for Ubuntu 22.04 (Jammy)
      apt_repository:
        repo: "deb [arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse"
        state: present
        filename: mongodb-org-8.0

    - name: Install MongoDB 8.0
      apt:
        name: mongodb-org
        state: present
        update_cache: yes

    - name: Enable and start MongoDB
      systemd:
        name: mongod
        state: started
        enabled: yes

    # ================================
    #         Open5GS EPC (4G) Installation
    # ================================
    - name: Add Open5GS PPA
      apt_repository:
        repo: ppa:open5gs/latest
        state: present

    - name: Install Open5GS EPC packages (4G)
      apt:
        name:
          - open5gs-mme # MME (Mobility Management Entity)
          - open5gs-sgwc # SGW-C (Serving Gateway Control)
          - open5gs-sgwu # SGW-U (Serving Gateway User Plane)
          - open5gs-pgw # PGW (PDN Gateway)
          - open5gs-hss # HSS (Home Subscriber Server)
          - open5gs-pcrf # PCRF (Policy Control)
        state: present
        update_cache: yes

    # ================================
    #         Configure EPC Components
    # ================================
    - name: Configure MME for 4G (MCC=001, MNC=01)
      copy:
        dest: /etc/open5gs/mme.yaml
        content: |
          mme:
            freeDiameter: /etc/freeDiameter/mme.conf
            s1ap:
              - addr: 10.10.0.3
            gtpc:
              - addr: 10.10.0.3
            metrics:
              - addr: 127.0.0.1
                port: 9090
            gummei:
              plmn_id:
                mcc: 001
                mnc: 01
              mme_gid: 2
              mme_code: 1
            tai:
              plmn_id:
                mcc: 001
                mnc: 01
              tac: 1
            security:
                integrity_order: [EIA2, EIA1, EIA0]
                ciphering_order: [EEA0, EEA1, EEA2]
            network_name:
                full: Open5GS

    - name: Configure SGW-C
      copy:
        dest: /etc/open5gs/sgwc.yaml
        content: |
          sgwc:
            gtpc:
              - addr: 10.10.0.3
            pfcp:
              - addr: 10.10.0.3

    - name: Configure SGW-U
      copy:
        dest: /etc/open5gs/sgwu.yaml
        content: |
          sgwu:
            pfcp:
              - addr: 10.10.0.3
            gtpu:
              - addr: 10.10.0.3

    - name: Configure PGW (PDN Gateway)
      copy:
        dest: /etc/open5gs/pgw.yaml
        content: |
          pgw:
            gtpc:
              - addr: 10.10.0.3
            gtpu:
              - addr: 10.10.0.3
            subnet:
              - addr: 10.45.0.1/16
            dns:
              - 8.8.8.8
              - 8.8.4.4
            metrics:
              - addr: 127.0.0.1
                port: 9090

    - name: Configure HSS (Home Subscriber Server)
      copy:
        dest: /etc/open5gs/hss.yaml
        content: |
          hss:
            freeDiameter: /etc/freeDiameter/hss.conf

    - name: Configure PCRF
      copy:
        dest: /etc/open5gs/pcrf.yaml
        content: |
          pcrf:
            freeDiameter: /etc/freeDiameter/pcrf.conf

    # ================================
    #         Setup IP Tables for UE connectivity
    # ================================
    - name: Enable IP forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        state: present
        reload: yes

    - name: Configure iptables for 4G UE traffic (ogstun)
      shell: |
        iptables -t nat -A POSTROUTING -s 10.45.0.0/16 ! -o ogstun -j MASQUERADE
        iptables-save > /etc/iptables/rules.v4
      args:
        creates: /etc/iptables/rules.v4

    # ================================
    #         Restart EPC Services
    # ================================
    - name: Restart Open5GS EPC services
      systemd:
        name: "{{ item }}"
        state: restarted
        enabled: yes
      loop:
        - open5gs-mmed
        - open5gs-sgwcd
        - open5gs-sgwud
        - open5gs-pgwd
        - open5gs-hssd
        - open5gs-pcrfd

    # ================================
    #         Add Test Subscriber to HSS
    # ================================
    - name: Add 4G test subscriber to MongoDB
      shell: |
        mongo --eval '
        db = db.getSiblingDB("open5gs");
        db.subscribers.insertOne({
          "imsi": "001010000000001",
          "msisdn": ["1234567890"],
          "security": {
            "k": "465B5CE8B199B49FAA5F0A2EE238A6BC",
            "opc": "E8ED289DEBA952E4283B54E88E6183CA",
            "amf": "8000"
          },
          "ambr": {
            "downlink": {"value": 1, "unit": 3},
            "uplink": {"value": 1, "unit": 3}
          },
          "slice": [
            {
              "sst": 1,
              "default_indicator": true,
              "session": [
                {
                  "name": "internet",
                  "type": 3,
                  "ambr": {
                    "downlink": {"value": 1, "unit": 3},
                    "uplink": {"value": 1, "unit": 3}
                  },
                  "qos": {
                    "index": 9,
                    "arp": {
                      "priority_level": 8,
                      "pre_emption_capability": 1,
                      "pre_emption_vulnerability": 1
                    }
                  }
                }
              ]
            }
          ]
        })'
      ignore_errors: yes

    # ================================
    #         Prometheus Setup
    # ================================
    - name: Download Prometheus
      unarchive:
        src: https://github.com/prometheus/prometheus/releases/download/v2.47.0/prometheus-2.47.0.linux-amd64.tar.gz
        dest: /opt
        remote_src: yes
        creates: /opt/prometheus-2.47.0.linux-amd64

    - name: Create Prometheus systemd service (port 9091)
      copy:
        dest: /etc/systemd/system/prometheus.service
        content: |
          [Unit]
          Description=Prometheus
          After=network.target

          [Service]
          Type=simple
          User=root
          ExecStart=/opt/prometheus-2.47.0.linux-amd64/prometheus --config.file=/opt/prometheus-2.47.0.linux-amd64/prometheus.yml --web.listen-address=0.0.0.0:9091
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target

    - name: Enable and start Prometheus
      systemd:
        name: prometheus
        state: restarted
        enabled: yes
        daemon_reload: yes

    - name: Display deployment complete message
      debug:
        msg: "âœ… Open5GS 4G EPC Deployment Complete! MME: 10.10.0.3, PGW: 10.10.0.3, Prometheus: http://<public-ip>:9091"

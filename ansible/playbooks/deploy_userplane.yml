---
- name: Deploy User Plane
  hosts: user_plane
  become: true
  vars:
    userplane_ip: "{{ hostvars['open5gs-userplane']['ansible_host'] }}"
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install prerequisites for MongoDB repository
      apt:
        name:
          - gnupg
          - curl
        state: present

    - name: Add MongoDB GPG key
      shell: |
        curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | \
        gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor
      args:
        creates: /usr/share/keyrings/mongodb-server-8.0.gpg

    - name: Add MongoDB repository
      apt_repository:
        repo: "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse"
        state: present
        filename: mongodb-org-8.0

    - name: Install MongoDB client tools
      apt:
        name: mongodb-mongosh
        state: present
        update_cache: yes

    - name: Add Open5GS PPA
      apt_repository:
        repo: ppa:open5gs/latest
        state: present

    - name: Install Open5GS
      apt:
        name: open5gs
        state: present
        update_cache: yes

    - name: Configure UPF
      template:
        src: ../templates/upf.yaml.j2
        dest: /etc/open5gs/upf.yaml
        backup: yes
      notify: Restart UPF

    - name: Configure SGW-U
      template:
        src: ../templates/sgwu.yaml.j2
        dest: /etc/open5gs/sgwu.yaml
        backup: yes
      notify: Restart SGWU

    - name: Enable IP forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes
        state: present
        reload: yes

    - name: Install iptables-persistent
      apt:
        name: iptables-persistent
        state: present

    - name: Configure NAT for 4G UE pool
      iptables:
        table: nat
        chain: POSTROUTING
        source: 10.45.0.0/16
        out_interface: "!ogstun"
        jump: MASQUERADE
      notify: Save iptables

    - name: Configure NAT for 5G UE pool
      iptables:
        table: nat
        chain: POSTROUTING
        source: 10.46.0.0/16
        out_interface: "!ogstun"
        jump: MASQUERADE
      notify: Save iptables

    - name: Allow ogstun input
      iptables:
        chain: INPUT
        in_interface: ogstun
        jump: ACCEPT
      notify: Save iptables

    - name: Allow ogstun forward in
      iptables:
        chain: FORWARD
        in_interface: ogstun
        jump: ACCEPT
      notify: Save iptables

    - name: Allow ogstun forward out
      iptables:
        chain: FORWARD
        out_interface: ogstun
        jump: ACCEPT
      notify: Save iptables

    - name: Enable and start user plane services
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - open5gs-upfd
        - open5gs-sgwud

    - name: Wait for UPF to be ready
      wait_for:
        port: 2152
        delay: 5
        timeout: 60

  handlers:
    - name: Restart UPF
      systemd:
        name: open5gs-upfd
        state: restarted

    - name: Restart SGWU
      systemd:
        name: open5gs-sgwud
        state: restarted

    - name: Save iptables
      command: netfilter-persistent save

---
- name: Deploy UERANSIM 5G RAN Simulator
  hosts: ran_nodes
  become: true
  tasks:
    - name: Fix DNS resolution
      shell: |
        echo "nameserver 8.8.8.8" | tee /etc/resolv.conf > /dev/null
        echo "nameserver 1.1.1.1" >> /etc/resolv.conf

    - name: Update system packages
      apt:
        update_cache: yes
        upgrade: dist
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Install build dependencies
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - build-essential
        - cmake
        - git
        - libsctp-dev
        - lksctp-tools
        - iproute2
        - iputils-ping
        - curl
        - wget
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Clone UERANSIM from GitHub
      git:
        repo: https://github.com/aligungr/UERANSIM
        dest: /home/ubuntu/UERANSIM
        version: v3.2.6
        update: yes
      register: git_result
      until: git_result is succeeded
      retries: 3
      delay: 5

    - name: Build UERANSIM (this may take 5-10 minutes)
      shell: |
        cd /home/ubuntu/UERANSIM
        make -j$(nproc)
      register: build_result
      timeout: 1200
      until: build_result is succeeded
      retries: 2
      delay: 10

    - name: Display build status
      debug:
        msg: "UERANSIM build completed with exit code: {{ build_result.rc }}"

    - name: Create UERANSIM config directory
      file:
        path: /home/ubuntu/UERANSIM/config
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"

    - name: Fix UERANSIM ownership
      file:
        path: /home/ubuntu/UERANSIM
        owner: ubuntu
        group: ubuntu
        recurse: yes

    - name: Create gNB configuration template
      copy:
        dest: /home/ubuntu/UERANSIM/config/open5gs-gnb.yaml
        content: |
          mcc: '999'
          mnc: '70'
          nci: '0x000000010'
          idLength: 32
          linkIp: 127.0.0.1
          ngapIp: 127.0.0.1
          gtpIp: 127.0.0.1
          amfConfigs:
            - address: 10.10.0.2
              port: 38412
          sliceSupportList:
            - sst: 0
          ignoreStreamIds: false
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Create UE configuration template
      copy:
        dest: /home/ubuntu/UERANSIM/config/open5gs-ue.yaml
        content: |
          test: true
          trackingAreaCode: '0x0001'
          keyResourceSetId: 0
          key: '465B5CE8B199B49FAA5F0A2EE238A6BC'
          op: 'E8ED289DEBA952E4283B54E88E6183CA'
          amf:
            host: 10.10.0.2
            port: 5555
          imsi: '999700000000001'
          imei: '356938035643803'
          imeiSv: '4105198890011101'
          sliceConfigs:
            - sst: 0
          defaultAs: '127.0.0.1'
          configureRouting: true
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: UERANSIM deployment complete
      debug:
        msg: "UERANSIM ready at /home/ubuntu/UERANSIM. Run: cd UERANSIM && ./nr-gnb -c config/open5gs-gnb.yaml"
        recurse: yes

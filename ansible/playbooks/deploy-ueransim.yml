---
- name: Deploy UERANSIM 5G RAN Simulator
  hosts: fiveg_all_in_one
  become: true
  tasks:
    # Single VM deployment: UERANSIM runs on same host as Open5GS Core

    - name: Fix DNS resolution
      shell: |
        echo "nameserver 8.8.8.8" | tee /etc/resolv.conf > /dev/null
        echo "nameserver 1.1.1.1" >> /etc/resolv.conf

    - name: Update system packages
      apt:
        update_cache: yes
        upgrade: dist
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Install build dependencies
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - build-essential
        - cmake
        - git
        - libsctp-dev
        - lksctp-tools
        - iproute2
        - iputils-ping
        - curl
        - wget
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Clone UERANSIM from GitHub
      git:
        repo: https://github.com/aligungr/UERANSIM
        dest: /home/ubuntu/UERANSIM
        version: v3.2.6
        update: yes
      register: git_result
      until: git_result is succeeded
      retries: 3
      delay: 5

    - name: Build UERANSIM (this may take 5-10 minutes)
      shell: |
        cd /home/ubuntu/UERANSIM
        make -j$(nproc)
      register: build_result
      timeout: 1200
      until: build_result is succeeded
      retries: 2
      delay: 10

    - name: Display build status
      debug:
        msg: "UERANSIM build completed with exit code: {{ build_result.rc }}"

    - name: Verify UERANSIM executables were built
      stat:
        path: "/home/ubuntu/UERANSIM/build/{{ item }}"
      loop:
        - nr-gnb
        - nr-ue
      register: binary_check

    - name: Display binary check results
      debug:
        msg: "{{ item.item }} exists: {{ item.stat.exists }}"
      loop: "{{ binary_check.results }}"

    - name: Create UERANSIM config directory
      file:
        path: /home/ubuntu/UERANSIM/config
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"

    - name: Fix UERANSIM ownership
      file:
        path: /home/ubuntu/UERANSIM
        owner: ubuntu
        group: ubuntu
        recurse: yes

    - name: Create gNB configuration template
      copy:
        dest: /home/ubuntu/UERANSIM/config/open5gs-gnb.yaml
        content: |
          mcc: '999'
          mnc: '70'
          nci: '0x000000010'
          idLength: 32
          tac: 1
          linkIp: 10.10.0.100   # vm-ran internal IP
          ngapIp: 10.10.0.100   # NGAP connection to AMF
          gtpIp: 10.10.0.100    # GTP-U tunnel endpoint
          amfConfigs:
            - address: 10.10.0.2  # vm-core AMF address
              port: 38412
          sliceSupportList:
            - sst: 1              # SST=1 is standard (not 0)
          ignoreStreamIds: false
        owner: ubuntu
        group: ubuntu
        mode: "0644"

    - name: Create UE configuration template
      copy:
        dest: /home/ubuntu/UERANSIM/config/open5gs-ue.yaml
        content: |
          # [Mandatory]
          supi: 'imsi-999700000000001'
          mcc: '999'
          mnc: '70'
          routingIndicator: '0000'

          # [Mandatory]
          key: '465B5CE8B199B49FAA5F0A2EE238A6BC'
          op: 'E8ED289DEBA952E4283B54E88E6183CA'
          opType: 'OPC'
          amf: '8000'

          # [Optional]
          imei: '356938035643803'
          imeiSv: '4370816125816151'

          # [Mandatory]
          gnbSearchList:
            - 10.10.0.100

          # [Optional]
          sessions:
            - type: 'IPv4'
              apn: 'internet'
              slice:
                sst: 1

          # [Optional]
          configured-nssai:
            - sst: 1

          # [Optional]
          default-nssai:
            - sst: 1

          # [Optional]
          integrity:
            IA1: true
            IA2: true
            IA3: true

          # [Optional]
          ciphering:
            EA1: true
            EA2: true
            EA3: true
        owner: ubuntu
        group: ubuntu
        mode: "0644"

    - name: UERANSIM deployment complete
      debug:
        msg: |
          ====================================
          UERANSIM Deployment Complete!
          ====================================
          Location: /home/ubuntu/UERANSIM

          To test gNB:
            cd /home/ubuntu/UERANSIM
            sudo ./build/nr-gnb -c config/open5gs-gnb.yaml

          To test UE (in another terminal):
            cd /home/ubuntu/UERANSIM
            sudo ./build/nr-ue -c config/open5gs-ue.yaml

          Expected: 'NG Setup procedure is successful' (gNB)
          Expected: 'MM-REGISTERED/NORMAL-SERVICE' (UE)
          ====================================

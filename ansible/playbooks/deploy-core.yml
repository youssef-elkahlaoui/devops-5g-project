---
- name: Deploy Open5GS 5G Core Network
  hosts: control_plane
  become: true
  tasks:
    - name: Fix DNS resolution
      shell: |
        echo "nameserver 8.8.8.8" | tee /etc/resolv.conf > /dev/null
        echo "nameserver 1.1.1.1" >> /etc/resolv.conf

    - name: Update system packages
      apt:
        update_cache: yes
        upgrade: dist
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Install required packages
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - gnupg
        - curl
        - wget
        - software-properties-common
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Add MongoDB GPG key
      shell: curl -fsSL https://www.mongodb.org/static/pgp/server-5.0.asc | apt-key add -
      ignore_errors: yes

    - name: Add MongoDB repository
      apt_repository:
        repo: deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/5.0 multiverse
        state: present
        filename: mongodb-org-5.0

    - name: Install MongoDB
      apt:
        name: mongodb-org
        state: present
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Add Open5GS PPA
      apt_repository:
        repo: ppa:open5gs/latest
        state: present

    - name: Install Open5GS packages
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - open5gs-nrf
        - open5gs-amf
        - open5gs-smf
        - open5gs-upf
        - open5gs-udm
        - open5gs-udr
        - open5gs-pcf
        - open5gs-ausf
        - open5gs-webui
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Enable IP forwarding (critical for NAT)
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes

    - name: Configure NAT masquerading for UE subnet
      shell: |
        iptables -t nat -A POSTROUTING -s 10.45.0.0/16 -j MASQUERADE
        iptables -t nat -A POSTROUTING -s 10.46.0.0/16 -j MASQUERADE
      ignore_errors: yes

    - name: Save iptables rules
      shell: iptables-save > /etc/iptables/rules.v4
      ignore_errors: yes

    - name: Start MongoDB
      systemd:
        name: mongod
        state: started
        enabled: yes
      register: mongodb_result
      until: mongodb_result is succeeded
      retries: 3
      delay: 5

    - name: Start Open5GS services
      systemd:
        name: open5gs-{{ item }}
        state: started
        enabled: yes
      loop:
        - nrf
        - amf
        - smf
        - upf
        - udm
        - udr
        - pcf
        - ausf
      register: service_result
      until: service_result is succeeded
      retries: 3
      delay: 5

    - name: Install Prometheus
      apt:
        name: prometheus
        state: present
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Start Prometheus
      systemd:
        name: prometheus
        state: started
        enabled: yes

    - name: Display Open5GS status
      shell: systemctl status open5gs-amf --no-pager
      ignore_errors: yes

    - name: Configuration complete
      debug:
        msg: "Open5GS core deployment completed. Services: NRF, AMF, SMF, UPF, UDM, UDR, PCF, AUSF"

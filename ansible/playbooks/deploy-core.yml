---
- name: Deploy Open5GS 5G Core Network
  hosts: fiveg_all_in_one
  become: true
  tasks:
    # CRITICAL: Setup SSH connectivity for UERANSIM deployment
    # This allows running deploy-ueransim.yml from vm-core
    - name: Generate SSH key for vm-core root user (for inter-VM communication)
      user:
        name: root
        generate_ssh_key: yes
        ssh_key_type: ed25519
        ssh_key_file: .ssh/id_ed25519
      ignore_errors: yes

    - name: Fix DNS resolution
      shell: |
        echo "nameserver 8.8.8.8" | tee /etc/resolv.conf > /dev/null
        echo "nameserver 1.1.1.1" >> /etc/resolv.conf

    - name: Update system packages
      apt:
        update_cache: yes
        upgrade: dist
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Install required packages
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - gnupg
        - curl
        - wget
        - software-properties-common
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Add MongoDB 8.0 GPG key (official pgp.mongodb.com)
      shell: |
        curl -fsSL https://pgp.mongodb.com/server-8.0.asc | \
        gpg --dearmor | \
        tee /usr/share/keyrings/mongodb-server-8.0.gpg > /dev/null
      ignore_errors: yes

    - name: Add MongoDB 8.0 repository for Ubuntu 22.04 (Jammy)
      apt_repository:
        repo: deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse
        state: present
        filename: mongodb-org-8.0

    - name: Update apt cache after MongoDB repository
      apt:
        update_cache: yes
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Install MongoDB
      apt:
        name: mongodb-org
        state: present
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Add Open5GS PPA
      apt_repository:
        repo: ppa:open5gs/latest
        state: present

    - name: Install Node.js (required for WebUI)
      shell: |
        curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /usr/share/keyrings/nodesource.gpg
        echo "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list
        apt-get update
        apt-get install -y nodejs
      ignore_errors: yes

    - name: Install Open5GS packages
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - open5gs-nrf
        - open5gs-amf
        - open5gs-smf
        - open5gs-upf
        - open5gs-udm
        - open5gs-udr
        - open5gs-pcf
        - open5gs-ausf
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Install Open5GS WebUI (using official installation script)
      shell: curl -fsSL https://open5gs.org/open5gs/assets/webui/install | bash -
      environment:
        SUDO_USER: root
      ignore_errors: yes

    # CRITICAL FIX: WebUI defaults to 'localhost' which binds to 127.0.0.1 (local only)
    # This prevents external access even with open firewall rules
    # Must change to '0.0.0.0' to accept connections from any interface
    - name: Configure WebUI to listen on all interfaces (0.0.0.0:9999)
      shell: |
        sed -i "s/const _hostname = process.env.HOSTNAME || 'localhost';/const _hostname = process.env.HOSTNAME || '0.0.0.0';/" /usr/lib/node_modules/open5gs/server/index.js
      ignore_errors: yes

    - name: Restart WebUI to apply configuration
      systemd:
        name: open5gs-webui
        state: restarted
      ignore_errors: yes

    - name: Enable IP forwarding (critical for NAT)
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes

    - name: Configure NAT masquerading for UE subnet
      shell: |
        iptables -t nat -A POSTROUTING -s 10.45.0.0/16 -j MASQUERADE
        iptables -t nat -A POSTROUTING -s 10.46.0.0/16 -j MASQUERADE
      ignore_errors: yes

    - name: Create iptables directory
      file:
        path: /etc/iptables
        state: directory
        mode: "0755"
      ignore_errors: yes

    - name: Save iptables rules
      shell: iptables-save > /etc/iptables/rules.v4
      ignore_errors: yes

    - name: Start MongoDB
      systemd:
        name: mongod
        state: started
        enabled: yes
      register: mongodb_result
      until: mongodb_result is succeeded
      retries: 3
      delay: 5

    # CRITICAL: Configure AMF to listen on actual IP (10.10.0.2) instead of localhost
    # This allows UERANSIM gNB to connect via NGAP on port 38412
    - name: Configure AMF to listen on 10.10.0.2 for NGAP
      shell: |
        sed -i 's/address: 127.0.0.5/address: 10.10.0.2/' /etc/open5gs/amf.yaml
      ignore_errors: yes

    - name: Configure SMF address for UPF association
      shell: |
        sed -i 's/addr: 127.0.0.4/addr: 10.10.0.2/' /etc/open5gs/smf.yaml
      ignore_errors: yes

    - name: Add test subscriber to MongoDB for UERANSIM
      shell: |
        mongosh --eval "
        db.subscribers.insertOne({
          imsi: '999700000000001',
          subscribed_rau_tau_timer: 12,
          network_access_mode: 0,
          subscriber_status: 0,
          access_restriction_data: 32,
          slice: [{
            sst: 1,
            default_indicator: true,
            session: [{
              name: 'internet',
              type: 3,
              qos: {
                index: 9,
                arp: { priority_level: 8, pre_emption_capability: 1, pre_emption_vulnerability: 1 }
              },
              ambr: { uplink: { value: 1, unit: 3 }, downlink: { value: 1, unit: 3 } },
              pcc_rule: []
            }]
          }],
          ambr: { uplink: { value: 1, unit: 3 }, downlink: { value: 1, unit: 3 } },
          security: {
            k: '465B5CE8B199B49FAA5F0A2EE238A6BC',
            amf: '8000',
            op: null,
            opc: 'E8ED289DEBA952E4283B54E88E6183CA'
          },
          schema_version: 1,
          __v: 0
        })
        " open5gs
      ignore_errors: yes
      register: subscriber_result

    - name: Display subscriber creation result
      debug:
        msg: "Subscriber added: {{ subscriber_result.stdout_lines }}"
      ignore_errors: yes

    - name: Start Open5GS services
      systemd:
        name: open5gs-{{ item }}d
        state: started
        enabled: yes
      loop:
        - nrf
        - amf
        - smf
        - upf
        - udm
        - udr
        - pcf
        - ausf
      register: service_result
      until: service_result is succeeded
      retries: 3
      delay: 5

    - name: Install Prometheus
      apt:
        name: prometheus
        state: present
      register: apt_result
      until: apt_result is succeeded
      retries: 3
      delay: 10

    - name: Create Prometheus data directory
      file:
        path: /var/lib/prometheus
        state: directory
        owner: prometheus
        group: prometheus
        mode: "0755"

    - name: Configure unified Prometheus for 5G + 4G monitoring
      shell: |
        # Unified Prometheus config - scrapes both vm-core (5G) and vm-4g-core (4G)
        cat > /etc/prometheus/prometheus.yml <<EOF
        global:
          scrape_interval: 15s
          evaluation_interval: 15s
          external_labels:
            cluster: 'telecom-5g-4g'
            environment: 'production'

        scrape_configs:
          # Prometheus self-monitoring
          - job_name: 'prometheus'
            static_configs:
              - targets: ['localhost:9091']
                labels:
                  instance: 'vm-core'
                  type: 'monitoring'
          
          # Open5GS 5G Core metrics (vm-core)
          - job_name: 'open5gs-5g'
            static_configs:
              - targets: ['localhost:9090']
                labels:
                  instance: 'vm-core'
                  network: '5g'
                  core_type: '5gc'
          
          # Open5GS 4G EPC metrics (vm-4g-core)
          - job_name: 'open5gs-4g'
            static_configs:
              - targets: ['10.10.0.3:9090']
                labels:
                  instance: 'vm-4g-core'
                  network: '4g'
                  core_type: 'epc'
          
          # Node exporter for system metrics (vm-core)
          - job_name: 'node-5g'
            static_configs:
              - targets: ['localhost:9100']
                labels:
                  instance: 'vm-core'
                  network: '5g'
          
          # Node exporter for system metrics (vm-4g-core)
          - job_name: 'node-4g'
            static_configs:
              - targets: ['10.10.0.3:9100']
                labels:
                  instance: 'vm-4g-core'
                  network: '4g'
        EOF

        # Fix ownership and permissions
        chown prometheus:prometheus /etc/prometheus/prometheus.yml
        chmod 644 /etc/prometheus/prometheus.yml
        chown -R prometheus:prometheus /var/lib/prometheus
        chown -R prometheus:prometheus /etc/prometheus

    - name: Configure Prometheus startup arguments
      lineinfile:
        path: /etc/default/prometheus
        regexp: "^ARGS="
        line: 'ARGS="--config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/var/lib/prometheus/metrics2/ --web.console.templates=/etc/prometheus/consoles --web.console.libraries=/etc/prometheus/console_libraries --web.listen-address=0.0.0.0:9091"'
        create: yes

    - name: Create Prometheus metrics directory
      file:
        path: /var/lib/prometheus/metrics2
        state: directory
        owner: prometheus
        group: prometheus
        mode: "0755"

    - name: Restart Prometheus to apply configuration
      systemd:
        name: prometheus
        state: restarted
        enabled: yes
        daemon_reload: yes
      register: prometheus_result
      retries: 3
      until: prometheus_result is succeeded
      delay: 5

    - name: Wait for Open5GS services to be ready
      wait_for:
        timeout: 10
      ignore_errors: yes

    - name: Verify Open5GS services are running
      shell: systemctl list-units --type=service --all | grep -E "open5gs-(nrf|amf|smf|upf|udm|udr|pcf|ausf)"
      register: service_check
      ignore_errors: yes

    - name: Enable SSH on vm-core for inter-VM Ansible execution
      systemd:
        name: ssh
        state: started
        enabled: yes
      ignore_errors: yes

    # ================================
    #         Node Exporter for System Metrics
    # ================================
    - name: Install Node Exporter
      apt:
        name: prometheus-node-exporter
        state: present
        update_cache: yes

    - name: Enable and start Node Exporter
      systemd:
        name: prometheus-node-exporter
        state: started
        enabled: yes

    # ================================
    #         Grafana Installation
    # ================================
    - name: Install Grafana dependencies
      apt:
        name:
          - apt-transport-https
          - software-properties-common
        state: present

    - name: Add Grafana GPG key
      shell: |
        wget -q -O - https://packages.grafana.com/gpg.key | gpg --dearmor | tee /usr/share/keyrings/grafana.gpg > /dev/null
      args:
        creates: /usr/share/keyrings/grafana.gpg

    - name: Add Grafana repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/grafana.gpg] https://packages.grafana.com/oss/deb stable main"
        state: present
        filename: grafana

    - name: Install Grafana
      apt:
        name: grafana
        state: present
        update_cache: yes

    - name: Configure Grafana to bind to 0.0.0.0
      lineinfile:
        path: /etc/grafana/grafana.ini
        regexp: "^;http_addr ="
        line: "http_addr = 0.0.0.0"
        backrefs: yes

    - name: Enable and start Grafana
      systemd:
        name: grafana-server
        state: started
        enabled: yes

    - name: Wait for Grafana to be ready
      wait_for:
        port: 3000
        delay: 5
        timeout: 30

    - name: Display SSH public key for manual setup (if needed)
      shell: cat /root/.ssh/id_ed25519.pub
      register: ssh_pubkey
      ignore_errors: yes

    - name: Deployment Complete - Unified Monitoring Ready
      debug:
        msg: |
          ====================================
          Open5GS 5G Core + Unified Monitoring ✅
          ====================================

          All services running:
          - MongoDB: mongod
          - Open5GS 5G: nrfd, amfd, smfd, upfd, udmd, udrd, pcfd, ausfd
          - Prometheus: port 9091 (scrapes both 5G and 4G)
          - Grafana: port 3000 (admin/admin)
          - Node Exporter: port 9100
          - WebUI: port 9999

          ====================================
          Unified Monitoring Dashboard:
          ====================================
          Prometheus: http://<vm-core-ip>:9091
          Grafana: http://<vm-core-ip>:3000

          Grafana will show metrics from:
            - vm-core (5G): Open5GS 5GC + UERANSIM
            - vm-4g-core (4G): Open5GS EPC + srsRAN

          Next: Deploy UERANSIM with:
            ansible-playbook -i inventory/hosts.ini playbooks/deploy-ueransim.yml

          Then: Deploy 4G on vm-4g-core with:
            ansible-playbook -i inventory/hosts.ini playbooks/deploy-4g-core.yml
            ansible-playbook -i inventory/hosts.ini playbooks/deploy-srsran.yml

          ===================================="

    - name: Display Open5GS services status
      debug:
        msg: "{{ service_check.stdout_lines }}"
      ignore_errors: yes

    - name: Configuration complete
      debug:
        msg: "✅ Open5GS 5G core deployment completed with unified monitoring. Prometheus + Grafana ready to monitor both 4G and 5G networks."

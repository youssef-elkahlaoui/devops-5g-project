---
- name: Deploy Open5GS 4G EPC Network + srsRAN on VM1
  hosts: vm1_4g_core
  become: true
  vars:
    vm1_ip: "10.10.0.10"
    vm3_monitoring_ip: "10.10.0.30"

  tasks:
    - name: Fix DNS resolution
      shell: |
        echo "nameserver 8.8.8.8" | tee /etc/resolv.conf > /dev/null
        echo "nameserver 1.1.1.1" >> /etc/resolv.conf

    - name: Update and upgrade apt packages
      apt:
        update_cache: yes
        upgrade: dist
        cache_valid_time: 3600

    - name: Install base dependencies
      apt:
        name:
          - software-properties-common
          - wget
          - curl
          - gnupg
          - git
          - net-tools
          - iptables
          - iputils-ping
          - tcpdump
          - vim
          - build-essential
          - cmake
          - libfftw3-dev
          - libmbedtls-dev
          - libboost-program-options-dev
          - libconfig++-dev
          - libsctp-dev
          - libuhd-dev
          - libzmq3-dev
        state: present

    # ================================
    #         MongoDB 8.0 Setup
    # ================================
    - name: Download MongoDB GPG key
      shell: |
        curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | \
        gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor
      args:
        creates: /usr/share/keyrings/mongodb-server-8.0.gpg

    - name: Add MongoDB repository for Ubuntu 22.04 (Jammy)
      apt_repository:
        repo: "deb [arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse"
        state: present
        filename: mongodb-org-8.0

    - name: Install MongoDB 8.0
      apt:
        name: mongodb-org
        state: present
        update_cache: yes

    - name: Enable and start MongoDB
      systemd:
        name: mongod
        state: started
        enabled: yes

    # ================================
    #         Open5GS EPC (4G) Installation
    # ================================
    - name: Add Open5GS PPA
      apt_repository:
        repo: ppa:open5gs/latest
        state: present

    - name: Install Node.js for WebUI
      shell: |
        curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /usr/share/keyrings/nodesource.gpg
        echo "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list
        apt-get update
        apt-get install -y nodejs
      ignore_errors: yes

    - name: Install Open5GS 4G EPC packages
      apt:
        name:
          - open5gs-mme
          - open5gs-sgwc
          - open5gs-sgwu
          - open5gs-pgw
          - open5gs-hss
          - open5gs-pcrf
        state: present
        update_cache: yes

    - name: Install Open5GS WebUI
      shell: curl -fsSL https://open5gs.org/open5gs/assets/webui/install | bash -
      environment:
        SUDO_USER: root
      ignore_errors: yes

    - name: Configure WebUI to listen on all interfaces
      shell: |
        sed -i "s/const _hostname = process.env.HOSTNAME || 'localhost';/const _hostname = process.env.HOSTNAME || '0.0.0.0';/" /usr/lib/node_modules/open5gs/server/index.js
      ignore_errors: yes

    - name: Configure MME for 4G (MCC=001, MNC=01)
      copy:
        dest: /etc/open5gs/mme.yaml
        content: |
          logger:
            file: /var/log/open5gs/mme.log

          mme:
            freeDiameter: /etc/freeDiameter/mme.conf
            s1ap:
              - addr: {{ vm1_ip }}
            gtpc:
              - addr: {{ vm1_ip }}
            metrics:
              - addr: 0.0.0.0
                port: 9090
            gummei:
              plmn_id:
                mcc: 001
                mnc: 01
              mme_gid: 2
              mme_code: 1
            tai:
              plmn_id:
                mcc: 001
                mnc: 01
              tac: 1
            security:
                integrity_order: [EIA2, EIA1, EIA0]
                ciphering_order: [EEA0, EEA1, EEA2]
            network_name:
                full: Open5GS-4G

    - name: Configure SGW-C
      copy:
        dest: /etc/open5gs/sgwc.yaml
        content: |
          logger:
            file: /var/log/open5gs/sgwc.log

          sgwc:
            gtpc:
              - addr: {{ vm1_ip }}
            pfcp:
              - addr: {{ vm1_ip }}

    - name: Configure SGW-U
      copy:
        dest: /etc/open5gs/sgwu.yaml
        content: |
          logger:
            file: /var/log/open5gs/sgwu.log

          sgwu:
            pfcp:
              - addr: {{ vm1_ip }}
            gtpu:
              - addr: {{ vm1_ip }}

    - name: Configure PGW (PDN Gateway)
      copy:
        dest: /etc/open5gs/pgw.yaml
        content: |
          logger:
            file: /var/log/open5gs/pgw.log

          pgw:
            gtpc:
              - addr: {{ vm1_ip }}
            gtpu:
              - addr: {{ vm1_ip }}
            subnet:
              - addr: 10.45.0.1/16
            dns:
              - 8.8.8.8
              - 8.8.4.4
            metrics:
              - addr: 0.0.0.0
                port: 9090

    - name: Configure HSS (Home Subscriber Server)
      copy:
        dest: /etc/open5gs/hss.yaml
        content: |
          logger:
            file: /var/log/open5gs/hss.log

          hss:
            freeDiameter: /etc/freeDiameter/hss.conf

    - name: Configure PCRF
      copy:
        dest: /etc/open5gs/pcrf.yaml
        content: |
          logger:
            file: /var/log/open5gs/pcrf.log

          pcrf:
            freeDiameter: /etc/freeDiameter/pcrf.conf

    # ================================
    #         Setup IP Tables for UE connectivity
    # ================================
    - name: Enable IP forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        state: present
        reload: yes

    - name: Create iptables directory
      file:
        path: /etc/iptables
        state: directory
        mode: "0755"

    - name: Configure iptables for 4G UE traffic (ogstun)
      shell: |
        iptables -t nat -A POSTROUTING -s 10.45.0.0/16 ! -o ogstun -j MASQUERADE
        iptables-save > /etc/iptables/rules.v4
      ignore_errors: yes

    - name: Start Open5GS 4G EPC services
      systemd:
        name: open5gs-{{ item }}d
        state: started
        enabled: yes
      loop:
        - hss
        - mme
        - sgwc
        - sgwu
        - pgw
        - pcrf

    - name: Wait for services to be ready
      wait_for:
        timeout: 10

    # ================================
    #         Add Test Subscriber
    # ================================
    - name: Add 4G test subscriber to MongoDB
      shell: |
        mongosh open5gs --eval '
        db.subscribers.insertOne({
          imsi: "001010000000001",
          msisdn: ["1234567890"],
          security: {
            k: "465B5CE8B199B49FAA5F0A2EE238A6BC",
            opc: "E8ED289DEBA952E4283B54E88E6183CA",
            amf: "8000"
          },
          ambr: {
            downlink: {value: 1, unit: 3},
            uplink: {value: 1, unit: 3}
          },
          slice: [{
            sst: 1,
            default_indicator: true,
            session: [{
              name: "internet",
              type: 3,
              ambr: {
                downlink: {value: 1, unit: 3},
                uplink: {value: 1, unit: 3}
              },
              qos: {
                index: 9,
                arp: {
                  priority_level: 8,
                  pre_emption_capability: 1,
                  pre_emption_vulnerability: 1
                }
              }
            }]
          }],
          schema_version: 1
        })'
      ignore_errors: yes

    # ================================
    #         Install srsRAN (eNB + UE)
    # ================================
    - name: Clone srsRAN repository
      git:
        repo: https://github.com/srsran/srsRAN_4G.git
        dest: /opt/srsRAN_4G
        version: master
      ignore_errors: yes

    - name: Build srsRAN
      shell: |
        cd /opt/srsRAN_4G
        mkdir -p build
        cd build
        cmake ../
        make -j$(nproc)
        make install
        ldconfig
      args:
        creates: /opt/srsRAN_4G/build/srsenb/src/srsenb

    - name: Create srsRAN config directory
      file:
        path: /etc/srsran
        state: directory
        mode: "0755"

    - name: Configure srsRAN eNB
      copy:
        dest: /etc/srsran/enb.conf
        content: |
          [enb]
          enb_id = 0x19B
          mcc = 001
          mnc = 01
          mme_addr = {{ vm1_ip }}
          gtp_bind_addr = {{ vm1_ip }}
          s1c_bind_addr = {{ vm1_ip }}
          n_prb = 50

          [enb_files]
          sib_config = /etc/srsran/sib.conf
          rr_config = /etc/srsran/rr.conf
          rb_config = /etc/srsran/rb.conf

    - name: Configure srsRAN UE
      copy:
        dest: /etc/srsran/ue.conf
        content: |
          [usim]
          mode = soft
          algo = milenage
          opc = E8ED289DEBA952E4283B54E88E6183CA
          k = 465B5CE8B199B49FAA5F0A2EE238A6BC
          imsi = 001010000000001
          imei = 353490069873319

          [rrc]
          ue_category = 4

          [nas]
          apn = internet
          force_imsi_attach = true

    # ================================
    #         Node Exporter for Monitoring
    # ================================
    - name: Install Node Exporter
      apt:
        name: prometheus-node-exporter
        state: present
        update_cache: yes

    - name: Enable and start Node Exporter
      systemd:
        name: prometheus-node-exporter
        state: started
        enabled: yes

    - name: Display deployment summary
      debug:
        msg: |
          ====================================
          VM1 (4G Core) Deployment Complete âœ…
          ====================================

          VM1 IP: {{ vm1_ip }}

          Services Running:
          - MongoDB (port 27017)
          - Open5GS 4G EPC: MME, SGW-C, SGW-U, PGW, HSS, PCRF
          - srsRAN: eNB + UE ready
          - Node Exporter (port 9100)
          - Open5GS Metrics (port 9090)
          - WebUI (port 9999)

          Test Subscriber:
          IMSI: 001010000000001
          K: 465B5CE8B199B49FAA5F0A2EE238A6BC
          OPc: E8ED289DEBA952E4283B54E88E6183CA

          Next Steps:
          1. Verify services: systemctl status open5gs-*
          2. Run test script: bash /home/ubuntu/test-vm1-4g.sh
          3. Start eNB: sudo srsenb /etc/srsran/enb.conf
          4. Start UE: sudo srsue /etc/srsran/ue.conf

          Metrics will be scraped by VM3 ({{ vm3_monitoring_ip }})
          ====================================

---
- name: Deploy Open5GS 5G Core Network + UERANSIM on VM2
  hosts: vm2_5g_core
  become: true
  vars:
    vm2_ip: "10.10.0.20"
    vm3_monitoring_ip: "10.10.0.30"

  tasks:
    - name: Fix DNS resolution
      shell: |
        echo "nameserver 8.8.8.8" | tee /etc/resolv.conf > /dev/null
        echo "nameserver 1.1.1.1" >> /etc/resolv.conf

    - name: Update system packages
      apt:
        update_cache: yes
        upgrade: dist

    - name: Install required packages
      apt:
        name:
          - gnupg
          - curl
          - wget
          - software-properties-common
          - build-essential
          - cmake
          - git
          - libsctp-dev
          - lksctp-tools
          - iproute2
          - net-tools
        state: present

    # ================================
    #         MongoDB 8.0 Setup
    # ================================
    - name: Download MongoDB GPG key
      shell: |
        curl -fsSL https://pgp.mongodb.com/server-8.0.asc | \
        gpg --dearmor | \
        tee /usr/share/keyrings/mongodb-server-8.0.gpg > /dev/null
      args:
        creates: /usr/share/keyrings/mongodb-server-8.0.gpg

    - name: Add MongoDB repository
      apt_repository:
        repo: deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse
        state: present
        filename: mongodb-org-8.0

    - name: Install MongoDB
      apt:
        name: mongodb-org
        state: present
        update_cache: yes

    - name: Enable and start MongoDB
      systemd:
        name: mongod
        state: started
        enabled: yes

    # ================================
    #         Open5GS 5G Core Installation
    # ================================
    - name: Add Open5GS PPA
      apt_repository:
        repo: ppa:open5gs/latest
        state: present

    - name: Install Node.js for WebUI
      shell: |
        curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /usr/share/keyrings/nodesource.gpg
        echo "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list
        apt-get update
        apt-get install -y nodejs
      ignore_errors: yes

    - name: Install Open5GS 5G Core packages
      apt:
        name:
          - open5gs-nrf
          - open5gs-amf
          - open5gs-smf
          - open5gs-upf
          - open5gs-udm
          - open5gs-udr
          - open5gs-pcf
          - open5gs-ausf
          - open5gs-nssf
        state: present
        update_cache: yes

    - name: Install Open5GS WebUI
      shell: curl -fsSL https://open5gs.org/open5gs/assets/webui/install | bash -
      environment:
        SUDO_USER: root
      ignore_errors: yes

    - name: Configure WebUI to listen on all interfaces
      shell: |
        sed -i "s/const _hostname = process.env.HOSTNAME || 'localhost';/const _hostname = process.env.HOSTNAME || '0.0.0.0';/" /usr/lib/node_modules/open5gs/server/index.js
      ignore_errors: yes

    # ================================
    #         Configure Open5GS 5G Core
    # ================================
    - name: Configure AMF to listen on VM2 IP
      shell: |
        sed -i 's/addr: 127.0.0.5/addr: {{ vm2_ip }}/' /etc/open5gs/amf.yaml
        sed -i 's/address: 127.0.0.5/address: {{ vm2_ip }}/' /etc/open5gs/amf.yaml

    - name: Configure SMF address
      shell: |
        sed -i 's/addr: 127.0.0.4/addr: {{ vm2_ip }}/' /etc/open5gs/smf.yaml

    - name: Configure UPF address
      shell: |
        sed -i 's/addr: 127.0.0.7/addr: {{ vm2_ip }}/' /etc/open5gs/upf.yaml

    - name: Configure NRF address
      shell: |
        sed -i 's/addr: 127.0.0.10/addr: {{ vm2_ip }}/' /etc/open5gs/nrf.yaml

    # ================================
    #         Setup IP forwarding and NAT
    # ================================
    - name: Enable IP forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_set: yes

    - name: Create iptables directory
      file:
        path: /etc/iptables
        state: directory
        mode: "0755"

    - name: Configure NAT for UE subnet
      shell: |
        iptables -t nat -A POSTROUTING -s 10.45.0.0/16 -j MASQUERADE
        iptables -t nat -A POSTROUTING -s 10.46.0.0/16 -j MASQUERADE
        iptables-save > /etc/iptables/rules.v4
      ignore_errors: yes

    # ================================
    #         Add Test Subscriber
    # ================================
    - name: Add 5G test subscriber to MongoDB
      shell: |
        mongosh open5gs --eval '
        db.subscribers.insertOne({
          imsi: "999700000000001",
          subscribed_rau_tau_timer: 12,
          network_access_mode: 0,
          subscriber_status: 0,
          access_restriction_data: 32,
          slice: [{
            sst: 1,
            default_indicator: true,
            session: [{
              name: "internet",
              type: 3,
              qos: {
                index: 9,
                arp: { priority_level: 8, pre_emption_capability: 1, pre_emption_vulnerability: 1 }
              },
              ambr: { uplink: { value: 1, unit: 3 }, downlink: { value: 1, unit: 3 } },
              pcc_rule: []
            }]
          }],
          ambr: { uplink: { value: 1, unit: 3 }, downlink: { value: 1, unit: 3 } },
          security: {
            k: "465B5CE8B199B49FAA5F0A2EE238A6BC",
            amf: "8000",
            op: null,
            opc: "E8ED289DEBA952E4283B54E88E6183CA"
          },
          schema_version: 1
        })'
      ignore_errors: yes

    # ================================
    #         Start Open5GS Services
    # ================================
    - name: Start Open5GS 5G Core services
      systemd:
        name: open5gs-{{ item }}d
        state: started
        enabled: yes
      loop:
        - nrf
        - amf
        - smf
        - upf
        - udm
        - udr
        - pcf
        - ausf
        - nssf

    - name: Wait for services to be ready
      wait_for:
        timeout: 10

    # ================================
    #         Install UERANSIM
    # ================================
    - name: Clone UERANSIM repository
      git:
        repo: https://github.com/aligungr/UERANSIM.git
        dest: /opt/UERANSIM
        version: master

    - name: Build UERANSIM
      shell: |
        cd /opt/UERANSIM
        make
      args:
        creates: /opt/UERANSIM/build/nr-gnb

    - name: Create UERANSIM config directory
      file:
        path: /etc/ueransim
        state: directory
        mode: "0755"

    - name: Configure UERANSIM gNB
      copy:
        dest: /etc/ueransim/gnb.yaml
        content: |
          mcc: '999'
          mnc: '70'
          nci: '0x000000010'
          idLength: 32
          tac: 1
          linkIp: {{ vm2_ip }}
          ngapIp: {{ vm2_ip }}
          gtpIp: {{ vm2_ip }}

          amfConfigs:
            - address: {{ vm2_ip }}
              port: 38412

          slices:
            - sst: 1
              sd: 0x000001

          ignoreStreamIds: true

    - name: Configure UERANSIM UE
      copy:
        dest: /etc/ueransim/ue.yaml
        content: |
          supi: 'imsi-999700000000001'
          mcc: '999'
          mnc: '70'
          key: '465B5CE8B199B49FAA5F0A2EE238A6BC'
          op: ''
          opc: 'E8ED289DEBA952E4283B54E88E6183CA'
          amf: '8000'
          imei: '356938035643803'
          imeiSv: '4370816125816151'

          gnbSearchList:
            - {{ vm2_ip }}

          sessions:
            - type: 'IPv4'
              apn: 'internet'
              slice:
                sst: 1
                sd: 0x000001

          configured-nssai:
            - sst: 1
              sd: 0x000001

          default-nssai:
            - sst: 1
              sd: 0x000001

          integrity:
            IA1: true
            IA2: true
            IA3: true

          ciphering:
            EA1: true
            EA2: true
            EA3: true

    # ================================
    #         Node Exporter for Monitoring
    # ================================
    - name: Install Node Exporter
      apt:
        name: prometheus-node-exporter
        state: present
        update_cache: yes

    - name: Enable and start Node Exporter
      systemd:
        name: prometheus-node-exporter
        state: started
        enabled: yes

    - name: Display deployment summary
      debug:
        msg: |
          ====================================
          VM2 (5G Core) Deployment Complete âœ…
          ====================================

          VM2 IP: {{ vm2_ip }}

          Services Running:
          - MongoDB (port 27017)
          - Open5GS 5G Core: NRF, AMF, SMF, UPF, UDM, UDR, PCF, AUSF, NSSF
          - UERANSIM: gNB + UE ready
          - Node Exporter (port 9100)
          - WebUI (port 9999)

          Test Subscriber:
          IMSI: 999700000000001
          MCC: 999, MNC: 70
          K: 465B5CE8B199B49FAA5F0A2EE238A6BC
          OPc: E8ED289DEBA952E4283B54E88E6183CA

          Next Steps:
          1. Verify services: systemctl status open5gs-*
          2. Run test script: bash /home/ubuntu/test-vm2-5g.sh
          3. Start gNB: sudo /opt/UERANSIM/build/nr-gnb -c /etc/ueransim/gnb.yaml
          4. Start UE: sudo /opt/UERANSIM/build/nr-ue -c /etc/ueransim/ue.yaml

          Metrics will be scraped by VM3 ({{ vm3_monitoring_ip }})
          ====================================

name: Health Check

on:
    schedule:
        - cron: "*/30 * * * *" # Every 30 minutes
    workflow_dispatch:

jobs:
    health-check:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to GCP
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Setup gcloud
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ secrets.GCP_PROJECT_ID }}

            - name: Check VMs Status
              run: |
                  echo "=== VM Status ==="
                  gcloud compute instances list --filter="name~open5gs" --format="table(name,status,networkInterfaces[0].networkIP)"

            - name: Check MME (4G)
              run: |
                  echo "=== Checking MME ==="
                  gcloud compute ssh open5gs-control --zone=us-central1-a --command="sudo ss -tlnp | grep 36412" || echo "MME not responding"

            - name: Check AMF (5G)
              run: |
                  echo "=== Checking AMF ==="
                  gcloud compute ssh open5gs-control --zone=us-central1-a --command="sudo ss -tlnp | grep 38412" || echo "AMF not responding"

            - name: Check UPF
              run: |
                  echo "=== Checking UPF ==="
                  gcloud compute ssh open5gs-userplane --zone=us-central1-a --command="sudo ss -ulnp | grep 2152" || echo "UPF not responding"

            - name: Check WebUI
              run: |
                  echo "=== Checking WebUI ==="
                  WEBUI_IP=$(gcloud compute instances describe open5gs-monitoring --zone=us-central1-a --format="get(networkInterfaces[0].accessConfigs[0].natIP)")
                  curl -s -o /dev/null -w "%{http_code}" http://${WEBUI_IP}:9999 || echo "WebUI not accessible"

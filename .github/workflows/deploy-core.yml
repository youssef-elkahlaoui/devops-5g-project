name: Deploy Open5GS Core

on:
    workflow_dispatch:
        inputs:
            component:
                description: "Component to deploy"
                required: true
                type: choice
                options:
                    - all
                    - mongodb
                    - 4g-core
                    - 5g-core
                    - userplane

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Ansible
              run: |
                  pip install ansible
                  ansible --version

            - name: Setup SSH Key
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa

            - name: Authenticate to GCP
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Configure SSH ProxyJump
              run: |
                  gcloud compute config-ssh --project=${{ secrets.GCP_PROJECT_ID }}

            - name: Deploy Component
              working-directory: ansible
              run: |
                  case "${{ github.event.inputs.component }}" in
                    all)
                      ansible-playbook playbooks/deploy_all.yml
                      ;;
                    mongodb)
                      ansible-playbook playbooks/deploy_mongodb.yml
                      ;;
                    4g-core)
                      ansible-playbook playbooks/deploy_4g.yml
                      ;;
                    5g-core)
                      ansible-playbook playbooks/deploy_5g.yml
                      ;;
                    userplane)
                      ansible-playbook playbooks/deploy_userplane.yml
                      ;;
                  esac
